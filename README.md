# wp-nginx-docker-compose
2021 wordpress

Requirements

- mkcert https://github.com/FiloSottile/mkcert
- docker (with docker-compose)
- gitBash (This is for Windows useless... I mean users).

Install Mkcert on Windows: 

	- Install choco https://chocolatey.org/install

		Install with powershell.exe:
		
		With PowerShell, you must ensure Get-ExecutionPolicy is not Restricted. We suggest using Bypass to bypass the policy to get things installed or AllSigned for quite a bit more security.

		Run `Get-ExecutionPolicy` 

		If it returns Restricted, then run `Set-ExecutionPolicy AllSigned` or `Set-ExecutionPolicy Bypass -Scope Process`.

		Now run the following command:
		
		`Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))`

		If you don't see any errors, you are ready to use Chocolatey!

	- In powerShell run: 
		
		`choco install mkcert`
		`mkcert -CAROOT`

	- Save the path in notepad
		Ex.: C:\Users\wellington.ramos\AppData\Local\mkcert


	- Run:
		mkcert -install


Create a local URL for your application (changing host file):

	 - Run Notepad as administrator
	 - Click File>Open and search for the host file like the example `c:\Windows\System32\Drivers\etc\hosts`
	 - Add the line `127.0.0.2 wordpress-docker.test` (You can choose any URL you want, just remember to update the nginx.conf file)
	 - Make sure you save the file and close it.

Create the SSL cert for HTTPS
	
	- Go back to the root folder of your WordPress application
	- Create a folder called `cert` (again you can use the name you prefer, just remember to update the docker, docker-compose, and nginx.conf files)
	- Open the terminal and go to this new cert folder. If you are working on Windows make sure to install gitBash because will make it much easier to install Choco, Mkacert, and use Mkcert. Don't ask me about other terminals for Windows because I have no idea how they work.
	- When inside the folder through the terminal type: (The following line is an example, remember to use your own URL if you choose another one)

	    `mkcert wordpress-docker.test "*.wordpress-docker.test" 127.0.0.2`

	This will generate two files and they will be similar to the examples:

	    `wordpress-docker.test+2.pem`
	    `wordpress-docker.test+2-key.pem`

	- Now, in your favorite text editor, open the file nginx.conf that is the Nginx folder of your WordPress application.
	- Go to lines 20 and 21 (At this moment) and update them with the names of the files generated by mkcert. They should look like this:

        `ssl_certificate     /etc/nginx/ssl/wordpress-docker.test+2.pem;`
        `ssl_certificate_key /etc/nginx/ssl/wordpress-docker.test+2-key.pem;`


Are you going to save the wp files or not?
		

	In the .gitignore file, I am ignoring the wp files, so if you want to commit the changes you are making there, remember to remove them from the .gitignore.


Run the containers!

	
	Using the terminal run in the root folder of your WordPress application the following docker command:

	docker-compose up -d

	This will create all the WordPress files and loads of other stuff, but you will see that the HTTPS is not working.


Tell Wordpress to work on HTTPS:


	- Search for `wp-config.php` file in the root folder of you Wordpress application.
	- Inside this file you will see loads of comments, scrool to the point it says `/* Add any custom values between this line and the "stop editing" line. */` and right under that line add:

	define('FORCE_SSL_ADMIN', true);
	if (strpos($_SERVER['HTTP_X_FORWARDED_PROTO'], 'https') !== false)
    	$_SERVER['HTTPS']='on';


    - Now go to the line `/* That's all, stop editing! Happy publishing. */` and above that add: (remember to use your own url if you are not using the same as I am).

    define('WP_HOME','https://wordpress-docker.test');
	define('WP_SITEURL','https://wordpress-docker.test');

Now let's see that HTTPS working.

	- Again in the root folder of you app run:

		docker-compose down

	- After the containers are down tou can run:

	 	docker-compose up --build -d

The --build tag was added to this step just to make sure docker-compose will rebuild the images. Then you can use without the --build in the future.

That is it, enjoy!